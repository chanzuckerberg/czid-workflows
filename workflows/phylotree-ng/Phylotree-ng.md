# PhyloTree Workflow: Technical Description

The following documentation applies to SKA-based PhyloTree-NG workflow.

## Inputs

- **Samples**: An array with information about each sample/pipeline run used to make the phylo tree.

  - **Sample Name**: The name the user has given the sample. Used to add user-friendly names to the phylotree.

  - **Workflow Run ID**: The run ID of the pipeline run.

  - **Combined contig summary**: The combined contig summary .json file (output by the mNGS pipeline), which contains information about which taxons the contigs map to.

  - **Contig fasta**: The contig .fasta file (output by the mNGS pipeline), which contains all contigs.

- **Reference Taxon ID**: Supplied by the user, the taxon ID of the organism of interest.

- **Superkingdom Name**: The superkingdom that the organism of interest belongs to.

- **Docker Image ID**: The docker image ID containing all necessary software.

## Outputs

- **Phylo Tree Newick**: File representing the phylo tree itself. This is saved as a string to the database and sent directly to the front end to build the phylo tree. The nodes on the tree have unique IDs corresponding to the name of the tree node. The IDs either correspond to pipeline run IDs for nodes that come from samples/pipeline runs, `genbank_{assembly_accession_id}.fasta` for nodes that come from genomes downloaded from genbank for reference taxon IDs, or `NCBI_NT_accession_{accession_id}.fasta` for nodes that come from reference sequences downloaded from the NCBI NT reference database.

- **Tree Image**: Outputs both an .svg file and a .png file containing the phylotree image consistent with the newick output.

- **Heatmap Image**: Outputs both an .svg file and a .png file containing the heatmap image of the SKA genomic distances.

- **SKA Distances File**: File (.tsv) output by SKA that contains information on relative genomic similarity between the samples. It includes the following metrics: `matches`, `mismatches`, `jaccard index`, `mash-like distance`, `SNPs`, `SNP distance`. These values are all computed using split kmers as documented in [SKA](https://github.com/simonrharris/SKA).

- **SKA Variants File**: File (.fasta) output by SKA that contains the variable sites identified through split kmers. This is used as input to IQtree for generating the final phylogenetic tree.

## Core Algorithm

### Get Sample Contig Fastas

For each sample/pipeline run a fasta is contructed by selecting the contigs associated with the taxID of interest (Reference Taxon ID). These files are generated by parsing the **Combined contig summary** and the **Contig fasta** inputs.

### Get Reference Accession Fastas

For each reference accession, the associated sequence is downloaded using [taxoniq](https://github.com/taxoniq/taxoniq).

### Run SKA

Given the sample contig fastas and the reference sequences, SKA is run to generate split kmer hashes from the input .fasta files (`ska fasta`) and to evaluate the relative genomic distance between samples (`ska distance`). The kmer length used to generate the split kmer hash files is dependent on the superkingdom; for viruses, k = 12 and for bacteria/eukaryotes, k = 18. 

### Compute Clusters

Given that SKA relies on kmer matching to evaluate distances, the reliability of this approach to generate phylogenetic relationships breaks down for divergent samples. This step uses the relative genomic distances computed in the previous step to generate clusters of samples that are closely related and outputs a heatmap summarizing the kmer distance relationships between the samples. If all samples are closely related (belong to the sample cluster) then a phylogenetic tree will be computed in the subsequent step. If not, then the pipeline will exit at this stage, resulting in only genomic distance heatmap outputs.

### Generate Cluster Phylos

If all samples are closely related (belong to the sample cluster) then a phylogenetic tree will be computed in this step by calling `ska align` to generate variant .fasta files that are then input to IQtree to create the phylogenetic tree. The output of this step is a newick file that is then passed to the front end for visualization in the IDseq web application.

### Add Sample Names

In two different steps, human-readable sample names are appended to the results.


## Additional Algorithm Components

### Download Accession Sequences 

This section outlines the heuristic used by the IDseq web application to select reference accessions to include in phylogenetic trees.

The NCBI NT references are downloaded for the most matched accession for each sample up to `n` (hardcoded to `10`) references. If there are more than `n` references to be downloaded, the top `n` by number of matches are selected. The selection and download are conducted in the following mannor.

For each sample, a count of the hits for each accession with the **taxon ID** anywhere in it's lineage are computed from the **refined hitsummaries from gsnap and rapsearch2**. The accession with the most hits for each sample has it's hits added to a counter. This means that if two samples have the same accession with the most hits their counts are combined. This also serves to deduplicate the accession sequences. This deduplication means that there may be fewer references downloaded than samples though there can never be more. If there are more than `n` accessions in the best accessions counter the `n` accessions with the highest combined number of hits are selected.

For each selected accession, the accession's sequence is obtained from s3 via taxoniq. If the look-up fails, the following error is produced: `Accession ID $accession_id not found in the index` 
