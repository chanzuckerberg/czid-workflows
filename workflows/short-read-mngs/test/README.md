# short-read-mngs unit tests

The [pytest](https://docs.pytest.org/en/stable/) suite has two stages:

1. The workflow runs end-to-end on one or more test inputs.
2. Task-level unit tests exercise error paths or corner cases that aren't otherwise covered by the workflow tests.

The workflow tests are triggered by session-scoped pytest fixtures, making their results available to the task-level cases. This two-stage structure allows the task unit tests to reuse intermediate inputs/outputs generated by the workflow tests, minimizing the boilerplate needed to express them.

For example, [`./conftest.py`](https://docs.pytest.org/en/stable/writing_plugins.html#conftest-py-plugins) has the workflow test fixture for a synthetic FASTQ pair to run using viral databases, `short_read_mngs_bench3_viral_outputs`. When pytest begins a task test case such as `host_filter/test_RunValidateInput.py`, the test case's dependency on the fixture (declared by the test function argument named `short_read_mngs_bench3_viral_outputs`) triggers it to first run the end-to-end workflow *if it hasn't already been* in the current session. The test function then re-runs just one step of the workflow, using inputs modified from those generated in the end-to-end run.

Many different test cases can similarly base themselves on individual steps in the workflow run triggered by the `short_read_mngs_bench3_viral_outputs` fixture. The test cases also use a `util` fixture defined in `../conftest.py`, which is effectively just an import of the helper functions in `../test_util`.

## Invocation

To run the short-read-mngs test suite locally, first enable the miniwdl download cache (to handle the ~6GB viral reference databases):

```bash
export MINIWDL__DOWNLOAD_CACHE__PUT=true
export MINIWDL__DOWNLOAD_CACHE__GET=true
export MINIWDL__DOWNLOAD_CACHE__DIR=/tmp/miniwdl_download_cache
```

Then, build the docker image from the current code revision and start the tests:

```bash
cd idseq-workflows
docker build -t idseq-short-read-mngs short-read-mngs
DOCKER_IMAGE_ID=idseq-short-read-mngs make test-short-read-mngs
```
